<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <!-- iPhone safe-areas + –∞–Ω—Ç–∏-–∑—É–º -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>–†–∏–Ω –ê–∫–∏—Ö–∞—Ä–∞ ‚Äî —Ç–≤–æ–π –∫–æ–º–ø–∞–Ω—å–æ–Ω</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>

  <script>
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    if (localStorage.getItem("rin-auth") !== "ok") {
      location.href = "/login.html";
    }
  </script>

  <!-- HEADER (–≤ —Å—Ç–∏–ª–µ Telegram) -->
  <header class="tg-header">
    <button class="tg-ico btn-back" aria-label="–ù–∞–∑–∞–¥" title="–ù–∞–∑–∞–¥">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
        <path d="M15 6L9 12L15 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    <div class="tg-peer">
      <img id="avatarTop" class="avatar" src="/avatar.jpg" alt="–†–∏–Ω" />
      <div class="peer-meta">
        <div class="peer-name">–†–∏–Ω –ê–∫–∏—Ö–∞—Ä–∞</div>
        <div id="peerStatus" class="peer-status">–æ–Ω–ª–∞–π–Ω</div>
      </div>
    </div>
    <div class="tg-actions"></div>
  </header>

  <main class="app">
    <section id="chat" class="chat" aria-live="polite"></section>

    <form id="form" autocomplete="off">
      <input id="input" type="text" placeholder="–ù–∞–ø–∏—à–∏ –†–∏–Ω‚Ä¶" maxlength="1000" required />
      <button id="send" type="submit" aria-label="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
          <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" fill="currentColor"/>
        </svg>
      </button>
    </form>
  </main>

  <script>
  // -------- CONFIG --------
  const TZ_OFFSET_MIN = 3 * 60; // GMT+3
  const STORAGE_KEY = 'rin-history-v2';
  const DAILY_INIT_KEY = 'rin-init-count';

  // -------- STATE --------
  const chatEl  = document.getElementById('chat');
  const formEl  = document.getElementById('form');
  const inputEl = document.getElementById('input');
  const peerStatus = document.getElementById('peerStatus');

  let persona = null, phrases = null, schedule = null;
  let history = [];

  // -------- HELPERS --------
  const nowLocal = () => new Date();
  const fmtDateKey = (d) => d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');

  function loadHistory(){
    try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; }
  }
  function saveHistory(h){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(h.slice(-60)));
  }

  // –í—Å—Ç–∞–≤–∫–∞ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è –¥–∞—Ç
  function ensureDateDivider(dateObj){
    const lastDivider = chatEl.querySelector('.date-divider:last-of-type');
    const today = new Date(); const todayKey = fmtDateKey(today);
    const msgKey = fmtDateKey(dateObj);

    if (lastDivider && lastDivider.dataset.key === msgKey) return;

    const label = (() => {
      const yesterday = new Date(); yesterday.setDate(today.getDate()-1);
      const yKey = fmtDateKey(yesterday);
      if (msgKey === todayKey) return '–°–µ–≥–æ–¥–Ω—è';
      if (msgKey === yKey)    return '–í—á–µ—Ä–∞';
      return msgKey.split('-').reverse().join('.');
    })();

    const div = document.createElement('div');
    div.className = 'date-divider';
    div.dataset.key = msgKey;
    div.innerHTML = `<span>${label}</span>`;
    chatEl.appendChild(div);
  }

  // –î–æ–±–∞–≤–∏—Ç—å –ø—É–∑—ã—Ä—å
  function addBubble(text, who='assistant', ts = Date.now()){
    const dateObj = new Date(ts);
    ensureDateDivider(dateObj);

    const row = document.createElement('div');
    row.className = 'row ' + (who === 'user' ? 'me' : 'her');

    if (who !== 'user') {
      const ava = document.createElement('img');
      ava.className = 'avatar small';
      ava.src = '/avatar.jpg';
      ava.alt = '–†–∏–Ω';
      row.appendChild(ava);
    } else {
      const spacer = document.createElement('div');
      spacer.className = 'avatar small spacer';
      row.appendChild(spacer);
    }

    const wrap = document.createElement('div');
    wrap.className = 'bubble ' + (who === 'user' ? 'me' : 'her');
    wrap.textContent = text;
    row.appendChild(wrap);

    chatEl.appendChild(row);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  // -------- INIT --------
  (async function init(){
    history = loadHistory();

    if (history.length) {
      let prevDay = '';
      for (const m of history) {
        const d = new Date(m.ts || Date.now());
        const key = fmtDateKey(d);
        if (key !== prevDay) { ensureDateDivider(d); prevDay = key; }
        addBubble(m.content, m.role === 'user' ? 'user' : 'assistant', m.ts);
      }
    } else {
      ensureDateDivider(new Date());
      addBubble('–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —è ‚Äî –†–∏–Ω. üå∏', 'assistant');
      history.push({ role:'assistant', content:'–ü—Ä–∏–≤–µ—Ç, —ç—Ç–æ —è ‚Äî –†–∏–Ω. üå∏', ts: Date.now() });
      saveHistory(history);
    }
  })();

  // -------- SEND --------
  formEl.addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = inputEl.value.trim();
    if (!text) return;

    addBubble(text, 'user');
    history.push({ role: 'user', content: text, ts: Date.now() });
    saveHistory(history);
    inputEl.value = '';
    inputEl.focus();

    peerStatus.textContent = '–ø–µ—á–∞—Ç–∞–µ—Ç‚Ä¶';
    const typingRow = document.createElement('div');
    typingRow.className = 'row her typing-row';
    typingRow.innerHTML = `
      <img class="avatar small" src="/avatar.jpg" alt="–†–∏–Ω" />
      <div class="bubble her typing"><span></span><span></span><span></span></div>
    `;
    chatEl.appendChild(typingRow);
    chatEl.scrollTop = chatEl.scrollHeight;

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          history, 
          pin: localStorage.getItem("rin-pin") // üîë –ø–µ—Ä–µ–¥–∞—ë–º PIN
        })
      });
      const data = await res.json();
      typingRow.remove();
      if (!res.ok) throw new Error(data?.detail || data?.error || ('HTTP ' + res.status));
      peerStatus.textContent = '–æ–Ω–ª–∞–π–Ω';
      addBubble(data.reply, 'assistant');
      history.push({ role:'assistant', content:data.reply, ts: Date.now() });
      saveHistory(history);
    } catch (err) {
      typingRow.remove();
      peerStatus.textContent = '–æ–Ω–ª–∞–π–Ω';
      addBubble('–û–π‚Ä¶ —Å–≤—è–∑—å —à–∞–ª–∏—Ç. ' + (err?.message || ''), 'assistant');
    }
  });
  </script>
</body>
</html>
