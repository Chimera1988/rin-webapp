<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <!-- –í–∞–∂–Ω–æ –¥–ª—è iOS –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ—Å—Ç–∏ –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö –∑–æ–Ω -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>–†–∏–Ω –ê–∫–∏—Ö–∞—Ä–∞ ‚Äî —Ç–≤–æ–π –∫–æ–º–ø–∞–Ω—å–æ–Ω</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body class="ios-fit">
  ...
</body>
  <main class="app">
    <header>
      <h1>–†–∏–Ω –ê–∫–∏—Ö–∞—Ä–∞</h1>
      <p class="sub">–¢—ë–ø–ª–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞, –ª—ë–≥–∫–∏–π —Ñ–ª–∏—Ä—Ç, –±–µ—Ä–µ–∂–Ω—ã–µ —Å–æ–≤–µ—Ç—ã</p>
    </header>

    <section id="chat" class="chat"></section>

    <form id="form">
      <input id="input" type="text" placeholder="–ù–∞–ø–∏—à–∏ –†–∏–Ω..." maxlength="1000" autocomplete="off" required />
      <button id="send" type="submit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </form>
  </main>

  <script>
    const chatEl = document.getElementById('chat');
    const formEl = document.getElementById('form');
    const inputEl = document.getElementById('input');

    // –ë–µ—Ä–µ–∂–Ω–∞—è "–ø–∞–º—è—Ç—å" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ localStorage
    const STORAGE_KEY = 'rin-history-v1';
    function loadHistory(){ try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; } }
    function saveHistory(h){ localStorage.setItem(STORAGE_KEY, JSON.stringify(h.slice(-30))); } // –¥–æ 30 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Ä–µ–ø–ª–∏–∫
    let history = loadHistory();

    function addBubble(text, who='assistant'){
      const wrap = document.createElement('div');
      wrap.className = 'bubble ' + (who === 'user' ? 'me' : 'her');
      wrap.textContent = text;
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    history.forEach(m => addBubble(m.content, m.role === 'user' ? 'user' : 'assistant'));

    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ, –µ—Å–ª–∏ –ø—É—Å—Ç–æ
    if (history.length === 0) {
      addBubble('–ü—Ä–∏–≤–µ—Ç, —è –†–∏–Ω. –•–æ—á–µ—à—å, –±—É–¥—É —Ä—è–¥–æ–º –∏ –ø–æ–º–æ–≥—É —Ä–∞–∑–æ–±—Ä–∞—Ç—å –º—ã—Å–ª–∏? üí´');
    }

    formEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = inputEl.value.trim();
      if (!text) return;
      addBubble(text, 'user');
      history.push({ role: 'user', content: text });
      saveHistory(history);
      inputEl.value = '';
      inputEl.focus();

      // –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –Ω–∞–±–æ—Ä–∞
      const typing = document.createElement('div');
      typing.className = 'bubble her typing';
      typing.innerHTML = '<span></span><span></span><span></span>';
      chatEl.appendChild(typing);
      chatEl.scrollTop = chatEl.scrollHeight;

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ history })
        });
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        typing.remove();
        addBubble(data.reply, 'assistant');
        history.push({ role: 'assistant', content: data.reply });
        saveHistory(history);
      } catch (err) {
        typing.remove();
        addBubble('–û–π‚Ä¶ —Å–≤—è–∑—å —à–∞–ª–∏—Ç. –ü–æ–ø—Ä–æ–±—É–µ–º –µ—â—ë —Ä–∞–∑?', 'assistant');
      }
    });
  </script>
</body>
</html>
<script>
  // iOS: –∫–æ–≥–¥–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –¥–µ—Ä–∂–∏–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—Å–µ–¥–∂ –≤ –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
  (function () {
    const chatEl = document.getElementById('chat');
    const inputEl = document.getElementById('input');

    function keepBottom() {
      // –°–∫—Ä–æ–ª–ª–∏–º –∫ –Ω–∏–∑—É —Å –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π ‚Äî –∫–æ–≥–¥–∞ —Ä–∞—Å–∫–ª–∞–¥–∫–∞ —É–∂–µ –∏–∑–º–µ–Ω–∏–ª–∞ –≤—ã—Å–æ—Ç—É
      setTimeout(() => { chatEl.scrollTop = chatEl.scrollHeight; }, 50);
    }

    // –ü—Ä–∏ —Ñ–æ–∫—É—Å–µ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–∏–∑—É–∞–ª—å–Ω–æ–≥–æ –≤—å—é–ø–æ—Ä—Ç–∞ ‚Äî –¥–µ—Ä–∂–∏–º—Å—è –≤–Ω–∏–∑—É
    inputEl.addEventListener('focus', keepBottom);
    if (window.visualViewport) {
      window.visualViewport.addEventListener('resize', keepBottom);
      window.visualViewport.addEventListener('scroll', keepBottom);
    }
  })();
</script>
